// ========================================
// SETTINGS SCHEMAS
// ========================================

// ==================== FINANCIAL SETTINGS ====================

model FinancialSettings {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  restaurantId String @db.ObjectId
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Currency
  currency String @default("USD")
  currencySymbol String @default("$")

  // Taxes (customizable list)
  taxes TaxSetting[]

  // Tips Configuration
  tipsEnabled Boolean @default(true)
  tipType String @default("percentage") // percentage, fixed, both
  defaultTipOptions Float[] @default([15, 18, 20])

  // Payment Provider Configuration
  paymentProvider String @default("stripe") // stripe, mercadopago
  paymentConfig Json? // Flexible config for different providers

  // Stripe Configuration
  stripeEnabled Boolean @default(false)
  stripeAccountId String?
  stripePublicKey String?
  stripeWebhookSecret String?
  stripeConnectStatus String @default("not_connected") // not_connected, pending, connected, failed, restricted
  stripeConnectDetails Json?
  usePlatformAccountFallback Boolean @default(true)

  // MercadoPago Configuration
  mercadoPagoEnabled Boolean @default(false)
  mercadoPagoAccessToken String?
  mercadoPagoPublicKey String?

  // Platform Fee Configuration
  globalFee GlobalFee?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId])
  @@map("financial_settings")
}

// Tax configuration (embedded)
type TaxSetting {
  name String
  enabled Boolean @default(true)
  rate Float
  type String @default("percentage") // percentage, fixed
  applyTo String @default("entire_order") // entire_order, per_item
}

// Global platform fee (embedded)
type GlobalFee {
  enabled Boolean @default(true)
  threshold Float @default(10)
  belowPercent Float @default(10)
  aboveFlat Float @default(1.95)
}

// ==================== DELIVERY SETTINGS ====================

model DeliverySettings {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  restaurantId String @db.ObjectId
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Basic Delivery Config
  enabled Boolean @default(true)
  distanceUnit String @default("miles") // miles, km
  maximumRadius Float @default(10)

  // Distance-based pricing with coverage zones
  pricingTiers DeliveryPricingTier[]

  // Driver Provider Configuration
  driverProvider String @default("local") // shipday, local

  // Note: Shipday and Mapbox credentials are provided at platform level via environment variables:
  // SHIPDAY_API_KEY, SHIPDAY_BASE_URL, SHIPDAY_DRY_RUN, DRIVER_PROVIDER
  // No need to store per-restaurant since platform manages these integrations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId])
  @@map("delivery_settings")
}

// Distance-based pricing tier (embedded)
type DeliveryPricingTier {
  name String @default("Default")
  distanceCovered Float // e.g., 10 km/miles
  baseFee Float // e.g., 10 dollars for first 10km
  additionalFeePerUnit Float // e.g., 2 dollars per km after 10km
  isDefault Boolean @default(false)
}

// ==================== STORE HOURS ====================

model StoreHours {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  restaurantId String @db.ObjectId
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // Timezone
  timezone String @default("America/New_York")

  // Weekly schedule with multiple time slots support
  schedule WeeklySchedule[]

  // Special closures and holiday hours
  specialClosures SpecialClosure[]

  // Holiday configuration
  holidayClosuresEnabled Boolean @default(true)
  holidays String[] @default([])

  // Legacy fields (kept for backwards compatibility during migration)
  monday DayHours?
  tuesday DayHours?
  wednesday DayHours?
  thursday DayHours?
  friday DayHours?
  saturday DayHours?
  sunday DayHours?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId])
  @@map("store_hours")
}

// Weekly schedule entry with multiple time slots (embedded)
type WeeklySchedule {
  day String // monday, tuesday, etc.
  isOpen Boolean @default(true)
  timeSlots ScheduleTimeSlot[]
}

// Time slot for weekly schedule (embedded)
type ScheduleTimeSlot {
  openTime String @default("09:00")
  closeTime String @default("17:00")
}

// Day hours (embedded) - Legacy format
type DayHours {
  isOpen Boolean @default(true)
  open String @default("09:00")
  close String @default("22:00")
}

// Special closure (embedded)
type SpecialClosure {
  date DateTime
  reason String?
  isFullDay Boolean @default(true)
  open String?
  close String?
}

// ==================== USER ROLES & PERMISSIONS ====================

model RolePermissions {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  restaurantId String @db.ObjectId
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  role String // owner, manager, kitchen, staff

  dashboard Boolean @default(true)
  menuManagement Boolean @default(false)
  orders Boolean @default(false)
  kitchen Boolean @default(false)
  customers Boolean @default(false)
  marketing Boolean @default(false)
  analytics Boolean @default(false)
  settings Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([restaurantId, role])
  @@map("role_permissions")
}

// ==================== PAYMENT TRANSACTIONS ====================

model Transaction {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  orderId String @db.ObjectId
  restaurantId String @db.ObjectId

  amount Float
  platformFee Float
  restaurantAmount Float

  paymentProvider String @default("stripe")
  paymentIntentId String?
  chargeId String?

  status String @default("pending") // pending, succeeded, failed, refunded, partially_refunded

  // Transfer information (for platform account payments)
  transferId String?
  transferAmount Float?
  transferStatus String?

  // Refund information
  refundedAmount Float?

  testMode Boolean @default(false)

  metadata Json?
  error String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([paymentIntentId])
  @@index([orderId])
  @@index([restaurantId])
  @@map("transactions")
}

// Update Restaurant model to include settings relations
// Add this to your existing Restaurant model:
//
// financialSettings FinancialSettings?
// deliverySettings  DeliverySettings?
// storeHours        StoreHours?
// rolePermissions   RolePermissions[]
